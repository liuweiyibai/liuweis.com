---
title: ä½¿ç”¨ Nuxt å¼€å‘åˆæ¢
date: 2021-05-24 20:00:30
category:
  - Vue
  - Nuxt
---

## å‰è¨€

Nuxt æ˜¯ Vue é…å¥—çš„ SSR æ¸²æŸ“æ¡†æ¶ã€‚ç”¨æ¥å®ç°æœåŠ¡ç«¯æ¸²æŸ“æ•ˆæœï¼Œå³æœåŠ¡ç«¯ç›´æ¥è¿”å›é™æ€ HTMLï¼Œå‡å°‘é¦–é¡µåŠ è½½èµ„æºæ—¶ç™½å±çš„æ—¶é—´ï¼Œæœ‰åˆ©äº SEO ä¼˜åŒ–ï¼Œç›®å‰æˆ‘ä»¬å›¢é˜Ÿæœ‰å‡ ä¸ªé¡µé¢è¦æ±‚è¿›è¡Œ SEO ä¼˜åŒ–ï¼Œå› ä¸ºæŠ€æœ¯æ ˆç”¨çš„æ˜¯ Vueï¼Œæ‰€ä»¥æœåŠ¡ç«¯æ¸²æŸ“æ¡†æ¶é€‰æ‹©äº† Nuxt

> Nuxt.js æ˜¯ä¸€ä¸ªåŸºäº Vue.js çš„é€šç”¨åº”ç”¨æ¡†æ¶ å®ƒé¢„è®¾äº†åˆ©ç”¨ Vue.js å¼€å‘æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆSSR, Server Side Renderï¼‰ çš„åº”ç”¨æ‰€éœ€è¦çš„å„ç§é…ç½®ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä¸€é”®ç”Ÿæˆé™æ€ç«™ç‚¹ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒNuxt.js æ˜¯åŸºäº Node.js çš„ï¼Œåç«¯å¦‚æœæ˜¯å…¶ä»–è¯­è¨€æ—¶ï¼Œæ˜¯å¦è€ƒè™‘åˆ°å†åŠ ä¸€å±‚ Node.js çš„åˆç†æ€§ã€‚
>
> [å®˜æ–¹ä¸­æ–‡æ–‡æ¡£](https://zh.nuxtjs.org/guide/installation)

## Vue SSR åŸç†å›¾

![vue ssr åŸç†å›¾](https://cdn.clearlywind.com/static/images/vue-ssråŸç†.png)

## åˆ›å»ºé¡¹ç›®

æŒ‰ç…§å®˜æ–¹æ–‡æ¡£èµ°å°±å¯ä»¥äº†ï¼Œæˆ‘é€‰æ‹©çš„æ˜¯ SSR æœåŠ¡ç«¯æ¸²æŸ“æ¨¡å¼

```bash
yarn create nuxt-app nuxt-demo
cd ./nuxt-demo
yarn dev
```

ä¸€ä¸ªåŸºç¡€çš„ Nuxt é¡¹ç›®å°±å·²ç»å¯åŠ¨èµ·æ¥äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹åŸºäºè¿™ä¸ªæ‰©å±•ä¸€ä¸‹è¿™ä¸ªé¡¹ç›®ï¼Œä»¥ä¸ºæˆ‘ä»¬æ˜¯ç§»åŠ¨ç«¯çš„é¡¹ç›®ï¼Œæ‰€ä»¥éœ€è¦é…ç½® CSS çš„å•ä½è½¬æ¢ï¼ŒPostCSSï¼ŒVant çš„æŒ‰éœ€å¼•å…¥ç­‰ã€‚

## å‡ ä¸ªç›¸å…³æ¦‚å¿µ

asyncData æ–¹æ³•æ˜¯ Nuxt.js å¯¹ Vue æ‰©å±•çš„æ–¹æ³•ã€‚ asyncData æœåŠ¡ç«¯è¯·æ±‚å¼‚æ­¥æ•°æ® (pages)ï¼Œä¼šåœ¨ç»„ä»¶ï¼ˆé™äºé¡µé¢ç»„ä»¶ï¼‰æ¯æ¬¡åˆå§‹åŒ–å‰è¢«è°ƒç”¨çš„ã€‚æ‰€ä»¥è¯¥æ–¹æ³•æ²¡æœ‰åŠæ³•é€šè¿‡ this æ¥å¼•ç”¨ç»„ä»¶çš„å®ä¾‹å¯¹è±¡ã€‚å®ƒå¯ä»¥åœ¨æœåŠ¡ç«¯æˆ–è·¯ç”±æ›´æ–°ä¹‹å‰è¢«è°ƒç”¨ã€‚å¯ä»¥åˆ©ç”¨ asyncData æ–¹æ³•æ¥è·å–æ•°æ®å¹¶è¿”å›ç»™å½“å‰ç»„ä»¶ã€‚æœ€åæŠŠè¦æ¸²æŸ“çš„æ•°æ® return å‡ºå»å°±è¡Œã€‚

```js
export default {
  async asyncData({ $axios, route }) {
    let data = await $axios('xxx/xxx/xx')
    return {
      data,
    }
  },
}
```

asyncData çš„å‚æ•°ï¼ˆcontextï¼‰æœ‰å“ªäº›ï¼Ÿ

1. appï¼šapp å¯¹è±¡
2. storeï¼šå­˜å‚¨ï¼Œå¯ä»¥æ‹¿åˆ° store é‡Œçš„æ•°æ®
3. routeï¼šè·¯ç”±ï¼Œå¯ä»¥æ‹¿åˆ°å‚æ•°ä¹‹ç±»çš„
4. paramsï¼šurl è·¯å¾„å‚æ•°ï¼Œä¸»è¦è·å– id
5. queryï¼šå¯ä»¥ç†è§£ä¸º url ä¸Šé—®å·åé¢çš„å‚æ•°
6. envï¼šè¿è¡Œç¯å¢ƒ
7. isDevï¼šæ˜¯å¦æ˜¯å¼€å‘ç¯å¢ƒ
8. isHMRï¼šæ˜¯å¦æ˜¯çƒ­æ›´æ–°
9. redirectï¼šé‡å®šå‘
10. errorï¼šé”™è¯¯

fetch æ–¹æ³•ç”¨äºæ¸²æŸ“é¡µé¢å‰å¡«å……åº”ç”¨çš„çŠ¶æ€æ ‘ï¼ˆstoreï¼‰æ•°æ®,ä¸ asyncData æ–¹æ³•ç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯å®ƒä¸ä¼šè®¾ç½®ç»„ä»¶çš„æ•°æ®ã€‚

```js
export default {
  async fetch({ store, params }) {
    const { data } = axios.get('http://url')
    store.commit('set/message', data)
  },
}
```

å¦‚æœåœ¨ vuex çŠ¶æ€æ ‘ä¸­æŒ‡å®šäº† nuxtServerInit æ–¹æ³•ï¼ŒNuxt.js è°ƒç”¨å®ƒçš„æ—¶å€™ä¼šå°†é¡µé¢çš„ä¸Šä¸‹æ–‡å¯¹è±¡ä½œä¸ºç¬¬ 2 ä¸ªå‚æ•°ä¼ ç»™å®ƒã€‚å½“æˆ‘ä»¬æƒ³å°†æœåŠ¡ç«¯çš„ä¸€äº›æ•°æ®ä¼ åˆ°å®¢æˆ·ç«¯æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æœåŠ¡ç«¯çš„ä¼šè¯çŠ¶æ€æ ‘é‡Œå¯ä»¥é€šè¿‡ req.session.user æ¥è®¿é—®å½“å‰ç™»å½•çš„ç”¨æˆ·ã€‚å°†è¯¥ç™»å½•ç”¨æˆ·ä¿¡æ¯ä¼ ç»™å®¢æˆ·ç«¯çš„çŠ¶æ€æ ‘ï¼Œæˆ‘ä»¬åªéœ€æ›´æ–° store/index.js å¦‚ä¸‹ï¼š

```js
export default {
  actions: {
    nuxtServerInit({ commit }, { req }) {
      if (req.session.user) {
        commit('user', req.session.user)
      }
    },
  },
}
```

- è·¯ç”±å®ˆå«

  å› ä¸ºæ˜¯æœåŠ¡ç«¯æ¸²æŸ“ï¼Œæ‰€ä»¥è·¯ç”±å®ˆå«è¦è€ƒè™‘åˆ°æœåŠ¡ç«¯è¿˜æ˜¯å®¢æˆ·ç«¯ç”Ÿæ•ˆåœºæ™¯ã€‚è·¯ç”±å®ˆå«åŒ…æ‹¬ï¼š

  å…¨å±€å®ˆå«å®šä¹‰åŒ…æ‹¬ï¼š

  1. åœ¨ nuxt.config çš„ middleware
  2. å®šä¹‰åœ¨ layout çš„ middleware
  3. å®šä¹‰åœ¨ plugins

  ç»„ä»¶å±€éƒ¨å®ˆå«ï¼šå®šä¹‰åœ¨ç»„ä»¶çš„ middleware

  å±€éƒ¨åç½®å®ˆå«ï¼šç»„ä»¶ beforeRouteLeave é’©å­

## meta

Nuxt å†…éƒ¨ä½¿ç”¨ vue-meta æ¥å¿«é€Ÿé…ç½®å„ä¸ªé¡µé¢æˆ–è€…ï¼Œæ•´ä¸ª website çš„ meta ä¿¡æ¯ï¼Œ[æ–‡æ¡£åœ°å€](https://nuxtjs.org/docs/2.x/features/meta-tags-seo)

```js
// nuxt.config.js
export default {
  head: {
    title: 'my website title',
    meta: [
      { charset: 'utf-8' },
      { name: 'viewport', content: 'width=device-width, initial-scale=1' },
      {
        hid: 'description',
        name: 'description',
        content: 'my website description',
      },
    ],
    link: [{ rel: 'icon', type: 'image/x-icon', href: '/favicon.ico' }],
  },
}
```

## Vant

å› ä¸ºé¡¹ç›®ä¸­å¹¶æ²¡æœ‰å…¨é‡ä½¿ç”¨åˆ° Vant çš„æ‰€æœ‰ç»„ä»¶ï¼ŒVant æŒ‰éœ€åŠ è½½ï¼Œå³åœ¨å¯¼å…¥ç»„ä»¶æ—¶è‡ªåŠ¨å¯¼å…¥ç»„ä»¶çš„æ ·å¼ã€‚

```bash
# è¿˜æ˜¯æŒ‡å®šç‰ˆæœ¬å®‰è£…ï¼Œä¸ç„¶æœ‰å‘
yarn add babel-plugin-import less@3.10.3 less-loader@5.0.0
```

```js
// nuxt.config.js
module.exports = {
  build: {
    // æ·»åŠ è¿™ä¸ªæ˜¯å…³é”®ï¼Œæ·»åŠ å babel æ‰ä¼šå¤„ç†ä¾èµ–åŒ… vant é‡Œé¢çš„ä»£ç 
    transpile: [/vant.*?less/],
    babel: {
      plugins: [
        [
          'import',
          {
            libraryName: 'vant',
            style: (name) => {
              return `${name}/style/less.js`
            },
          },
          'vant',
        ],
      ],
    },
  },

  // ä¹Ÿå¯ä»¥ä¿®æ”¹ vant å†…éƒ¨ less å˜é‡
  loaders: {
    less: {
      javascriptEnabled: true,
      modifyVars: {
        'nav-bar-title-font-size': '80px',
      },
    },
  },
}
```

## Sass

```bash
# å®‰è£… sass-loader æŒ‡å®šç‰ˆæœ¬ï¼Œå› ä¸ºé«˜ç‰ˆæœ¬æœ‰å…¼å®¹æ€§çš„å‘
yarn add sass-loader@10 sass --dev

# åŠ è½½ less styls sass å˜é‡
yarn add @nuxtjs/style-resources --dev
```

å¯¹åº”åœ¨é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨

```js
// nuxt.config.js
module.exports = {
  // å…¨å±€ css æ ·å¼ä¸€å¦‚ï¼Œpsï¼šå•ç‹¬çš„ scss æ–‡ä»¶ä¸­ä½¿ç”¨å˜é‡è¦å•ç‹¬å¼•å…¥
  css: ['@/assets/scss/main.scss'],
  buildModules: ['@nuxtjs/style-resources'],
  styleResources: {
    // your settings here
    sass: [],
    scss: [
      // éœ€è¦ä½¿ç”¨ç›¸å¯¹è·¯å¾„å¼•å…¥
      './assets/vars/*.scss',
      './assets/abstracts/_mixin.scss',
    ],
    less: [],
    stylus: [],
  },
}
```

å°±å¯ä»¥åœ¨ vue ç»„ä»¶ä¸­ç›´æ¥ä½¿ç”¨ scss å˜é‡äº†

## Rem å¤„ç†

```bash
yarn add amfe-flexible
yarn add postcss-pxtorem@5.1.1 --dev # é¿å…æŠ¥é”™ï¼Œå®‰è£…æŒ‡å®šç‰ˆæœ¬
```

[ä¸ºä»€ä¹ˆé€‰ç”¨ postcss-pxtorem](https://www.npmtrends.com/postcss-plugin-px2rem-vs-postcss-px2rem-vs-postcss-pxtorem) npm ä¸‹è½½é‡æœ€é«˜ï¼

è¿™ç§æœåŠ¡ç«¯æ¸²æŸ“ï¼Œæœ€åˆé€‚çš„ç§»åŠ¨ç«¯é€‚é…æ–¹æ¡ˆåº”è¯¥æ˜¯ vw æ–¹æ¡ˆï¼Œä½†æ˜¯æˆ‘å¸äº§å“è¦æ±‚å®ç°åœ¨ PC ç«¯ä¹Ÿè¦ä¿æŒç§»åŠ¨ç«¯é¡µé¢çš„å®½åº¦ï¼Œä¹Ÿå°±æ˜¯è¶…è¿‡ 640pxï¼Œå®¹å™¨çš„å®½åº¦æœ€å¤§å°±æ˜¯ 640pxï¼Œå¹¶ä¸”å­—ä½“å¤§å°è¦æŒ‰ç…§ 640px å®½åº¦æ¥è®¡ç®—ï¼Œæ‰€ä»¥ vw æ–¹æ¡ˆè¢« passã€‚

å¦‚æœä½¿ç”¨ plugins æ–¹å¼è½½å…¥ amfe-flexible æ’ä»¶ï¼Œä¼šé€ æˆé¡µé¢ç¬¬ä¸€æ¬¡åŠ è½½æ—¶æœ‰é—ªçƒé—®é¢˜ã€‚å› ä¸ºä½¿ç”¨ plugins è½½å…¥æ­¤æ’ä»¶ js æ—¶ï¼Œå¯èƒ½ä¼šåœ¨æ–‡æ¡£åŠ è½½ç»“æŸä¹‹åï¼Œæ‰åŠ è½½æ­¤ jsï¼Œæ‰€ä»¥æ­¤ js å¯èƒ½åœ¨æ–‡æ¡£åŠ è½½å®Œæˆä¹‹åæ‰æ‰§è¡Œï¼Œæ‰€ä»¥å¯¼è‡´é¡µé¢é‡æ–°è®¡ç®—å•ä½å¤§å°ï¼Œæ‰€ä»¥åº”è¯¥åœ¨ head ä¸­å¯¼å…¥æ¬¡ jsï¼Œåœ¨æ–‡æ¡£æœ€é¡¶å±‚æ‰§è¡Œï¼Œé¿å…æ­¤é—®é¢˜ã€‚

## click å»¶è¿Ÿ

è€ç”Ÿå¸¸è°ˆçš„ç§»åŠ¨ç«¯ click 300ms å»¶è¿Ÿé—®é¢˜ï¼Œä½¿ç”¨ Fastclick æ¥è§£å†³ï¼ŒåŒæ ·è¦åœ¨ head ä¸­ã€‚

## env

```bash
# dotenv è½½å…¥ç¯å¢ƒæ–‡ä»¶
yarn add @nuxtjs/dotenv --dev
```

å¯¹åº”ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š

```js
module.exports = {
  modules: [
    ...,
    // Simple usage
    '@nuxtjs/dotenv',

    // With options
    [
      '@nuxtjs/dotenv',
      {
        /* module options */
      },
    ],
  ],
}
```

## æ—¥å¿—

[npm](https://www.npmjs.com/package/nuxt-winston-log)

```bash
yarn add nuxt-winston-log
```

## æ„å»º

[æ„å»ºç›¸å…³é…ç½®æ–‡æ¡£](https://nuxtjs.org/docs/2.x/configuration-glossary/configuration-build)ï¼Œå¯ä»¥ä¿®æ”¹æ„å»ºäº§ç‰©ç›¸å…³é…ç½®

```js
// nuxt.config.js
module.exports = {
  build: {
    // css ç‹¬ç«‹æ‰“åŒ… link çš„å½¢å¼åŠ è½½
    extractCSS: { allChunks: true },

    // æŒ‡å®šæ‰“åŒ…è·¯å¾„ä¸ºdistï¼Œé»˜è®¤è·¯å¾„ä¸º [_nuxt] æˆ–è€…å¯ä»¥æŒ‡å®šcdn åŸŸå
    publicPath: '/static/',

    // css å’Œ jsã€img æ‰“åŒ…æ—¶æŒ‡å®šæ–‡ä»¶å¤¹
    filenames: {
      app: ({ isDev }) => (isDev ? '[name].js' : '[chunkhash].js'),
      chunk: ({ isDev }) => (isDev ? '[name].js' : '[chunkhash].js'),
      css: ({ isDev }) => (isDev ? '[name].js' : '[contenthash].css'),
      img: ({ isDev }) => (isDev ? '[path][name].[ext]' : '[hash:7].[ext]'),
    },
  },

  // è¾“å‡º css link è·¯å¾„ä¼šä¿®æ”¹ä¸ºï¼š /static/[contenthash].css
  // æ³¨æ„ï¼šé™æ€èµ„æºæ–‡ä»¶è·¯å¾„åä¸èƒ½å’Œé¡µé¢è·¯ç”±åç§°ç›¸åŒï¼ŒpublicPath é»˜è®¤é…ç½® '/' æ— æ•ˆ
}
```

## å…¶ä»–ä½¿ç”¨ç»†èŠ‚

- å¯ä»¥ä½¿ç”¨ middleware æ¥ä»£æ›¿ å…¨å±€è·¯ç”±é’©å­çš„å·¥ä½œ

  åœ¨ nuxt ä¸­ä½¿ç”¨ å…¨å±€è·¯ç”±é’©å­ï¼Œç©ä¸æ˜ç™½å°±ä¼šæ­»å¾ªç¯ ğŸ˜‘

- ä½¿ç”¨ nuxt ä¸º vuex æä¾›çš„ nuxtServerInit æä¾›çš„å‡½æ•°

  æ¯”å¦‚ website è½½å…¥ä¹‹å‰ store éœ€è¦å­˜å‚¨å“ªäº›æ•°æ®

## ç¦æ­¢ Nuxt.js é¥æµ‹

```js
// nuxt.config.js
export default {
  telemetry: false,
}
```

## éƒ¨ç½²

- PM2

  ```bash
  build # æ„å»ºé™æ€æ–‡ä»¶å’Œserverä»£ç 
  yarn start # å¯åŠ¨ nuxt æä¾›çš„ node server
  # pm2 å¯åŠ¨
  pm2 start npm --name "nuxt-demo" -- run start
  ```

- Docker

  Docker æ„å»ºï¼Œä½¿ç”¨ PM2 éƒ¨ç½²

  ```dockerfile
  FROM node:alpine

  WORKDIR /app

  RUN npm i -g pm2
  RUN npm i yarn -g

  COPY ./package*.json ./

  RUN yarn install \
    --prefer-offline \
    --frozen-lockfile \
    --non-interactive \
    --production=false

  # Build app
  RUN yarn run build

  RUN rm -rf node_modules && \
    NODE_ENV=production yarn install \
    --prefer-offline \
    --pure-lockfile \
    --non-interactive \
    --production=true

  EXPOSE 3000

  USER node

  CMD [ "pm2-runtime", "start", "npm", "--", "start" ]
  ```

## æœ€å

æœ€åæ”¾ä¸€å¼  Nuxt.js çš„ç”Ÿå‘½å‘¨æœŸå›¾å§ï¼

![Nuxt.js ç”Ÿå‘½å‘¨æœŸå›¾](https://cdn.clearlywind.com/static/images/nuxt-lifecycle.png)
